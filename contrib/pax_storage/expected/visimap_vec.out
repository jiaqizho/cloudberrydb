set vector.enable_vectorization = on;
-- set the number of tuples in a group to 5,
-- so we can test multiple group with visimap,
-- at the beginning, in the middle, or at the end
-- of a group.
set pax_max_tuples_per_group = 5;
create table pt1(a int, b int) using pax;
insert into pt1 select 1, i from generate_series(1,15)i;
select ctid, * from pt1;
  ctid  | a | b  
--------+---+----
 (0,1)  | 1 |  1
 (0,2)  | 1 |  2
 (0,3)  | 1 |  3
 (0,4)  | 1 |  4
 (0,5)  | 1 |  5
 (0,6)  | 1 |  6
 (0,7)  | 1 |  7
 (0,8)  | 1 |  8
 (0,9)  | 1 |  9
 (0,10) | 1 | 10
 (0,11) | 1 | 11
 (0,12) | 1 | 12
 (0,13) | 1 | 13
 (0,14) | 1 | 14
 (0,15) | 1 | 15
(15 rows)

begin;
delete from pt1 where b < 2;
select ctid, * from pt1;
  ctid  | a | b  
--------+---+----
 (0,2)  | 1 |  2
 (0,3)  | 1 |  3
 (0,4)  | 1 |  4
 (0,5)  | 1 |  5
 (0,6)  | 1 |  6
 (0,7)  | 1 |  7
 (0,8)  | 1 |  8
 (0,9)  | 1 |  9
 (0,10) | 1 | 10
 (0,11) | 1 | 11
 (0,12) | 1 | 12
 (0,13) | 1 | 13
 (0,14) | 1 | 14
 (0,15) | 1 | 15
(14 rows)

rollback;
begin;
delete from pt1 where b = 5;
select ctid, * from pt1;
  ctid  | a | b  
--------+---+----
 (0,1)  | 1 |  1
 (0,2)  | 1 |  2
 (0,3)  | 1 |  3
 (0,4)  | 1 |  4
 (0,6)  | 1 |  6
 (0,7)  | 1 |  7
 (0,8)  | 1 |  8
 (0,9)  | 1 |  9
 (0,10) | 1 | 10
 (0,11) | 1 | 11
 (0,12) | 1 | 12
 (0,13) | 1 | 13
 (0,14) | 1 | 14
 (0,15) | 1 | 15
(14 rows)

rollback;
begin;
delete from pt1 where b >= 6 and b <= 7;
select ctid, * from pt1;
  ctid  | a | b  
--------+---+----
 (0,1)  | 1 |  1
 (0,2)  | 1 |  2
 (0,3)  | 1 |  3
 (0,4)  | 1 |  4
 (0,5)  | 1 |  5
 (0,8)  | 1 |  8
 (0,9)  | 1 |  9
 (0,10) | 1 | 10
 (0,11) | 1 | 11
 (0,12) | 1 | 12
 (0,13) | 1 | 13
 (0,14) | 1 | 14
 (0,15) | 1 | 15
(13 rows)

rollback;
begin;
delete from pt1 where b = 8;
select ctid, * from pt1;
  ctid  | a | b  
--------+---+----
 (0,1)  | 1 |  1
 (0,2)  | 1 |  2
 (0,3)  | 1 |  3
 (0,4)  | 1 |  4
 (0,5)  | 1 |  5
 (0,6)  | 1 |  6
 (0,7)  | 1 |  7
 (0,9)  | 1 |  9
 (0,10) | 1 | 10
 (0,11) | 1 | 11
 (0,12) | 1 | 12
 (0,13) | 1 | 13
 (0,14) | 1 | 14
 (0,15) | 1 | 15
(14 rows)

rollback;
begin;
delete from pt1 where b > 7 and b <= 10;
select ctid, * from pt1;
  ctid  | a | b  
--------+---+----
 (0,1)  | 1 |  1
 (0,2)  | 1 |  2
 (0,3)  | 1 |  3
 (0,4)  | 1 |  4
 (0,5)  | 1 |  5
 (0,6)  | 1 |  6
 (0,7)  | 1 |  7
 (0,11) | 1 | 11
 (0,12) | 1 | 12
 (0,13) | 1 | 13
 (0,14) | 1 | 14
 (0,15) | 1 | 15
(12 rows)

rollback;
-- Test if visimap works well with btree index
create unique index on pt1(a, b);
begin;
delete from pt1 where b >= 4 and b < 8;
select ctid, * from pt1;
  ctid  | a | b  
--------+---+----
 (0,1)  | 1 |  1
 (0,2)  | 1 |  2
 (0,3)  | 1 |  3
 (0,8)  | 1 |  8
 (0,9)  | 1 |  9
 (0,10) | 1 | 10
 (0,11) | 1 | 11
 (0,12) | 1 | 12
 (0,13) | 1 | 13
 (0,14) | 1 | 14
 (0,15) | 1 | 15
(11 rows)

explain (costs off) select * from pt1 where a = 1 and b >= 2 and b < 10;
                     QUERY PLAN                      
-----------------------------------------------------
 Vec Gather Motion 1:1  (slice1; segments: 1)
   ->  Vec Seq Scan on pt1
         Filter: ((a = 1) AND (b >= 2) AND (b < 10))
 Optimizer: Pivotal Optimizer (GPORCA)
(4 rows)

select * from pt1 where a = 1 and b >= 2 and b < 10;
 a | b 
---+---
 1 | 2
 1 | 3
 1 | 8
 1 | 9
(4 rows)

rollback;
drop table pt1;
reset pax_max_tuples_per_group;
reset vector.enable_vectorization;
